{% extends 'base.html' %}
{% load bootstrap %}

{% block content %}

<style type="text/css">
  #question-container {
    padding-top: 15px;
    margin: 0 auto;
    text-align: center;
    max-width: 50%;
    }

  .btn-round {
    width: 60px;
    height: 60px;
    max-width: 100%;
    max-height: 100%;
    font-size:20px;
    border-radius: 50%;
    position: fixed;
  }
  #previous-button {
    left: 2%;
    top: 30%;
  }
  #next-button {
    right: 2%;
    top: 30%;
  }
  h3 {
    text-align: center;
  }

</style>
<html>

  <a href="{% url 'patient:detail' patient.slug %}" style="border-radius: 0;" class="btn btn-dark"><</a>

  <button id="next-button" onclick="next()" class="btn btn-success btn-round">&rarr;</button>
  <button id="previous-button" onclick="previous()" class="btn btn-success btn-round">&larr;</button>

  <h3> Patient n°{{patient.incl_num}}</h3>

  <div id="question-container">
    <div class="progress">
      <div id="algo-progress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div><br>
    {% for key, values in questions.items %}
        <div id="{{key}}" style="display: none;" class="btn-group-vertical">
          <h4> {{values.question}} </h4><hr>
          {% for ans in values.answers %}
            {% if ans %}
              <input type="radio" class="btn-check" value="{{ans}}" name="options-outlined {{key}}" id="{{key}}-{{ans}}" autocomplete="off">
              <label class="btn btn-outline-secondary" for="{{key}}-{{ans}}">{{ans}}</label>
            {% endif %}
          {% endfor %}
        </div>
        <div id="conclusions" style="display: none;" class="btn-group-vertical">
          <h4> Conclusions </h4><hr>

        </div>

    {% endfor %}

    <div id="final" style="display: none; text-align: left;"> </div>
    <br>

    <button id="submit-result-button" onclick="send_results()" class="btn btn-success" style="display: none;">Enregistrer les résultats</button>
    <form id="algo-form" method="post">{% csrf_token %}</form>

  </div>
</html>


<script type="text/javascript">

  const init_algo = {{algo|safe}};
  const questions = {{quests|safe}};
  var current_qid = null;
  var results = {}
  var conclusions = {};
  var current_traitement = 'conclusion';
  start_algo()

  function p_update(value){
    document.getElementById("algo-progress").setAttribute('style', "width: " + value + "%");
  }

  function show_question(qid) {
    document.getElementById("next-button").style.display = 'inline';
    if (Object.keys(results).length === 0) {
      document.getElementById("previous-button").style.display = 'none';
    }
    else {
      document.getElementById("previous-button").style.display = 'inline';
    }
    if (current_qid != null) {
      document.getElementById(current_qid).style.display = 'none';
    }
    document.getElementById(qid).style.display = 'inline';
    current_qid = qid
  }

  function show_conclusions() {
    document.getElementById('conclusions').style.display = 'inline';
    document.getElementById("previous-button").style.display = 'inline';
    document.getElementById("next-button").style.display = 'none';
    if (current_qid != null) {
      document.getElementById(current_qid).style.display = 'none';
    }
    var content = "<h4>Conclusions</h4><hr>";
    for (const [key, value] of Object.entries(conclusions)) {
      if (key != 'null') {
        content += "<strong>"+key+": </strong>";
      }
      content += "<a>"+value+"</a><br>";
    }
    document.getElementById('conclusions').innerHTML = content;
    current_qid = 'conclusions'
  }

  function next() {
    var radios = document.getElementsByName("options-outlined " + current_qid);
    for (var radio of radios) {
      if (radio.checked) {
        results[current_qid] = radio.value;
        return start_algo();
      }
    }
  }

  function previous() {
    const last_qid = Object.keys(results)[Object.keys(results).length-1];
    delete results[last_qid];
    start_algo();
  }


  function start_algo() {
    p_update(0);
    try {
      algorithm(init_algo);
      show_conclusions();
      p_update(100);
    }
    catch (out) {
      show_question(out);
    }
  }

  function algorithm(algo) {
    if (typeof algo == "string"){
      conclusions[current_traitement] = algo;
      return;
    }

    for (const [step, subalgo] of Object.entries(algo)) {
      key = step.split(' #')[0];
      prog = parseInt(step.split(' #')[1]);
      p_update((prog-1) / 28 * 100);
      if (key in results) {
        if ('details' in questions[key]) {
          current_traitement = key;
        }
        if (results[key] in subalgo){
          algorithm(subalgo[results[key]]);
        }
      }
      else if (key in questions) {
        throw key;
      }
    }
  }


</script>
{% endblock content %}
