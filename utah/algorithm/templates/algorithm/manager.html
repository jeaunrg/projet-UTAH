{% extends 'base.html' %}
{% load bootstrap %}

{% block content %}

<style type="text/css">
  #question-container {
    padding-top: 15px;
    margin: 0 auto;
    text-align: center;
    max-width: 50%;
    }

  .btn-round {
    width: 60px;
    height: 60px;
    max-width: 100%;
    max-height: 100%;
    font-size:20px;
    border-radius: 50%;
    position: fixed;
  }
  #previous-button {
    left: 2%;
    top: 30%;
  }
  #next-button {
    right: 2%;
    top: 30%;
  }
  h3 {
    text-align: center;
  }

</style>
<html>

  <a href="{% url 'patient:detail' patient.slug %}" style="border-radius: 0;" class="btn btn-dark"><</a>

  <button id="next-button" onclick="next()" class="btn btn-success btn-round">&rarr;</button>
  <button id="previous-button" onclick="previous()" class="btn btn-success btn-round">&larr;</button>

  <h3> Patient n°{{patient.hosp_num}}</h3>

  <div id="question-container">
    <div class="progress">
      <div id="algo-progress" class="progress-bar" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div><br>
    {% for key, values in questions.items %}
        <div id="{{key}}" style="display: none;" class="btn-group-vertical">
          <h4> {{values.question}} </h4><hr>
          {% for ans in values.answers %}
            {% if ans %}
              <input type="radio" class="btn-check" value="{{ans}}" name="options-outlined {{key}}" id="{{key}}-{{ans}}" autocomplete="off">
              <label class="btn btn-outline-secondary" for="{{key}}-{{ans}}">{{ans}}</label>
            {% endif %}
          {% endfor %}
        </div>
    {% endfor %}

    <div id="final" style="display: none; text-align: left;"> </div>
    <br>

    <button id="submit-result-button" onclick="send_results()" class="btn btn-success" style="display: none;">Enregistrer les résultats</button>
    <form id="algo-form" method="post">{% csrf_token %}</form>

  </div>
</html>


<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

{% include 'algorithm/algorithm.html' %}

<script type="text/javascript">

  if ("{{auto_skip}}" == "True") {
    var rp = {{default_responses | safe}};
  } else {
    var rp = {};
  }

  var current_question_id = null;
  var conclusion = null;
  var progress_value = 0;
  const progress_step = 20;
  set_default_responses();
  answer();

  function next() {
    var radios = document.getElementsByName("options-outlined " + current_question_id);
    for (var radio of radios) {
      if (radio.checked) {
        p_update(progress_step);
        return answer(response=radio.value);
      }
    }
  }

  function previous() {
    // remove last response

    const last_question_id = Object.keys(rp)[Object.keys(rp).length-1];
    delete rp[last_question_id];
    p_update(-progress_step);
    return answer();
  }


  function show_response(response){
    var content = "";

    if (response.includes('\n')) {
      content += "<h4>Avant l'intervention</h4><hr>";
      content += sentence2html(response.split('\n')[0]);
      content += "<h4>Après l'intervention</h4><hr>";
      content += sentence2html(response.split('\n')[1]);
    }
    else {
      content += "<h4>Conclusion</h4><hr>";
      content += sentence2html(response);
    }
    document.getElementById(current_question_id).style.display = 'none';
    document.getElementById('next-button').style.display = 'none';
    document.getElementById('previous-button').style.display = 'inline';
    document.getElementById('submit-result-button').style.display = 'inline';
    document.getElementById('final').style.display = 'inline';
    document.getElementById('final').innerHTML = content;
    conclusion = response;
    current_question_id = "final";
    p_update('end');
  }

  function show_question(question_id) {
    if (Object.keys(rp).length == 0){
      p_update('start');
      document.getElementById('previous-button').style.display = 'none';
    }
    else {
      document.getElementById('previous-button').style.display = 'inline';
    }
    document.getElementById('submit-result-button').style.display = 'none';
    document.getElementById('next-button').style.display = 'inline';
    document.getElementById(question_id).style.display = 'inline';
    if (current_question_id != null) {
      document.getElementById(current_question_id).style.display = 'none';
    }
    current_question_id = question_id;
  }

  function answer(response=null) {
    if (response != null) {
      rp[current_question_id] = response;
    }

    try {
      show_response(algorithm());
    } catch (question){
      show_question(question);
    }
  }


  function print(d) {
    window.alert(JSON.stringify(d, null, 4));
  }

  function set_default_responses(){
    for (const [key, value] of Object.entries({{default_responses | safe}})) {
      if (document.getElementById(key+'-'+value) != null) {
        document.getElementById(key+'-'+value).checked = true;
      }
    }
  }

  function sentence2html(sentence) {
    var html = "";
    for (const line of sentence.split('. ')) {
      html += "<p>" + line + "</p>";
    }
    return html
  }

  function p_update(value){
    if (value == 'end') {
      progress_value = 100;
    } else if (value == 'start') {
      progress_value = 0;
    } else {
      progress_value += value;
    }
    document.getElementById("algo-progress").setAttribute('style', "width: " + progress_value + "%");
  }

  function G(question_id) {
    if (question_id in rp) {
      return rp[question_id];
    }
    else {
      throw question_id;
    }
  }

  function flags(question_id) {
    return {{questions.traitement1.answers | safe}}[G(question_id)];
  }

  function send_results() {
    rp['algo_result'] = conclusion;
    const form = document.getElementById('algo-form');

    for (const key in rp) {
      if (rp.hasOwnProperty(key)) {
        const hiddenField = document.createElement('input');
        hiddenField.type = 'hidden';
        hiddenField.name = key;
        hiddenField.value = rp[key];

        form.appendChild(hiddenField);
      }
    }

    document.body.appendChild(form);
    form.submit();
  }

</script>



{% endblock content %}
